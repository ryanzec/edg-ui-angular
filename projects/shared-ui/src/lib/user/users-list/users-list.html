<div [class]="mergeClasses('flex flex-col gap-2 w-full', containerClass())">
  @if (enableFilters()) {
    <div class="flex flex-col gap-2">
      <form [formGroup]="filterForm">
        <org-form-fields [reserveValidationSpace]="false">
          <org-form-field>
            <org-input formControlName="nameSearch" name="users-list-name-search" placeholder="Search by name..." />
          </org-form-field>
          <org-form-field>
            <org-form-fields [reserveValidationSpace]="false" containerClass="flex-row">
              <org-form-field containerClass="w-auto">
                <org-combobox
                  formControlName="dateField"
                  name="users-list-date-field"
                  [options]="dateFieldOptions"
                  placeholder="Select date field..."
                  containerClass="w-[200px]"
                />
              </org-form-field>
              <org-form-field containerClass="flex-1">
                <org-date-picker-input
                  formControlName="dateValue"
                  name="users-list-date-value"
                  [allowRangeSelection]="true"
                  [allowPartialRangeSelection]="true"
                  placeholder="Select date range..."
                  class="flex-1"
                />
              </org-form-field>
            </org-form-fields>
          </org-form-field>
        </org-form-fields>
      </form>
    </div>
  }

  @if (isLoading()) {
    <div class="flex justify-center items-center w-full">
      <org-skeleton type="table" class="w-full" />
    </div>
  } @else if (users().length === 0) {
    <div class="flex justify-center items-center p-8">
      <div>No users found</div>
    </div>
  } @else {
    <org-table [data]="users()" [containerClass]="tableContainerClass()" [isBackgroundLoading]="isBackgroundLoading()">
      <ng-template #header>
        <tr>
          <th
            class="px-4 py-3 text-left font-semibold text-sm text-table-header-text bg-table-header-background sticky top-0 z-10"
            [orgSortable]="'name'"
            [sortableEnabled]="enableSorting()"
          >
            Name
          </th>
          <th
            class="px-4 py-3 text-left font-semibold text-sm text-table-header-text bg-table-header-background sticky top-0 z-10"
          >
            Email
          </th>
          <th
            class="px-4 py-3 text-left font-semibold text-sm text-table-header-text bg-table-header-background sticky top-0 z-10"
          >
            Roles
          </th>
          <th
            class="px-4 py-3 text-left font-semibold text-sm text-table-header-text bg-table-header-background sticky top-0 z-10"
            [orgSortable]="'createdAt'"
            [sortableEnabled]="enableSorting()"
          >
            Created
          </th>
          <th
            class="w-[50px] px-4 py-3 text-left font-semibold text-sm text-table-header-text bg-table-header-background sticky top-0 z-10"
          ></th>
        </tr>
      </ng-template>
      <ng-template #body let-tempUser>
        @let user = asUser(tempUser);
        <tr class="border-b border-table-row-border last:border-b-0 hover:bg-table-row-hover">
          <td class="px-4 py-3 text-sm text-table-text">{{ user.name }}</td>
          <td class="px-4 py-3 text-sm text-table-text">{{ user.email }}</td>
          <td class="px-4 py-3 text-sm text-table-text">
            <div class="flex flex-row gap-1.5">
              @for (role of user.roles; track role) {
                <org-tag [color]="getRoleColor(role)" variant="weak">
                  {{ role }}
                </org-tag>
              }
            </div>
          </td>
          <td class="px-4 py-3 text-sm text-table-text"><org-date-display [date]="toDateTime(user.createdAt)" /></td>
          <td class="px-4 py-3 text-sm text-table-text">
            <div class="flex justify-end">
              <org-button
                [cdkMenuTriggerFor]="userActionsMenu"
                [cdkMenuPosition]="menuPosition"
                color="neutral"
                variant="ghost"
                [icon]="'dots-three'"
                size="sm"
                aria-label="User actions"
                data-testid="user-actions-button"
              />
              <ng-template #userActionsMenu>
                <org-overlay-menu
                  [menuItems]="getUserActionsMenuItems(user)"
                  (menuItemClicked)="onUserActionMenuItemClick($event, user)"
                />
              </ng-template>
            </div>
          </td>
        </tr>
      </ng-template>
    </org-table>
    @if (hasPagination()) {
      <org-pagination
        [disabled]="paginationDisabled()"
        (pageChanged)="onPageChanged($event)"
        (itemsPerPageChanged)="onItemsPerPageChanged($event)"
      />
    }
  }
</div>
