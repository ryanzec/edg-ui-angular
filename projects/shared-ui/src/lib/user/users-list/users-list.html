<div [class]="mergeClasses('flex flex-col gap-2 w-full', containerClass())">
  @if (enableFilters()) {
    <div class="flex flex-col gap-2">
      <form [formGroup]="filterForm">
        <org-form-fields [reserveValidationSpace]="false">
          <org-form-field>
            <org-input formControlName="name" name="users-list-name-search" placeholder="Search by name..." />
          </org-form-field>
          <org-form-field>
            <org-form-fields [reserveValidationSpace]="false" containerClass="flex-row">
              <org-form-field containerClass="w-auto">
                <org-combobox
                  formControlName="dateType"
                  name="users-list-date-field"
                  [options]="dateFieldOptions"
                  placeholder="Select date field..."
                  containerClass="w-[200px]"
                />
              </org-form-field>
              <org-form-field containerClass="flex-1">
                <org-date-picker-input
                  formControlName="dateValue"
                  name="users-list-date-value"
                  [allowRangeSelection]="true"
                  [allowPartialRangeSelection]="true"
                  placeholder="Select date range..."
                  class="flex-1"
                />
              </org-form-field>
            </org-form-fields>
          </org-form-field>
        </org-form-fields>
      </form>
    </div>
  }

  @if (isInitialLoading()) {
    <div class="flex justify-center items-center w-full">
      <org-skeleton type="table" class="w-full" />
    </div>
  } @else if (users().length === 0) {
    <div class="flex justify-center items-center p-8">
      <div>No users found</div>
    </div>
  } @else {
    <org-table [data]="users()" [containerClass]="tableContainerClass()" [isLoading]="isLoading()">
      <ng-template #header>
        <org-table-tr variant="header" [isSticky]="true">
          <org-table-th>
            <div [orgSortable]="'name'" [sortableEnabled]="enableSorting()">Name</div>
          </org-table-th>
          <org-table-th containerClass="w-[200px]">Email</org-table-th>
          <org-table-th containerClass="w-[200px]">Roles</org-table-th>
          <org-table-th containerClass="w-[200px]">
            <div [orgSortable]="'createdAt'" [sortableEnabled]="enableSorting()">Created</div>
          </org-table-th>
          <org-table-th containerClass="w-[50px]"></org-table-th>
        </org-table-tr>
      </ng-template>
      <ng-template #body let-tempUser>
        @let user = asUser(tempUser);
        <org-table-tr>
          <org-table-td>{{ user.name }}</org-table-td>
          <org-table-td>{{ user.email }}</org-table-td>
          <org-table-td>
            <div class="flex flex-row gap-1.5">
              @for (role of user.roles; track role) {
                <org-tag [color]="getRoleColor(role)" variant="weak">
                  {{ role }}
                </org-tag>
              }
            </div>
          </org-table-td>
          <org-table-td><org-date-display [date]="toDateTime(user.createdAt)" /></org-table-td>
          <org-table-td>
            <div class="flex justify-end">
              <org-button
                [cdkMenuTriggerFor]="userActionsMenu"
                [cdkMenuPosition]="usersActionsMenuPosition"
                color="neutral"
                variant="ghost"
                [icon]="'dots-three'"
                size="sm"
                aria-label="User actions"
                data-testid="user-actions-button"
              />
              <ng-template #userActionsMenu>
                <org-overlay-menu
                  [menuItems]="usersActionsMenuItems"
                  (menuItemClicked)="onUserActionMenuItemClick($event, user)"
                />
              </ng-template>
            </div>
          </org-table-td>
        </org-table-tr>
      </ng-template>
    </org-table>

    @if (listingType() === 'page') {
      <org-pagination
        [disabled]="paginationDisabled()"
        [(currentPage)]="currentPage"
        [totalItems]="totalItems()"
        [(itemsPerPage)]="itemsPerPage"
        [visiblePages]="visiblePages()"
        [itemsPerPageOptions]="itemsPerPageOptions"
      />
    }

    @if (listingType() === 'infinite' && hasMore()) {
      <org-button
        color="neutral"
        variant="ghost"
        aria-label="Load more users"
        data-testid="load-more-users-button"
        [disabled]="loadMoreDisabled()"
        (clicked)="onRequestMoreUsers()"
      >
        Load more
      </org-button>
    }
  }
</div>
